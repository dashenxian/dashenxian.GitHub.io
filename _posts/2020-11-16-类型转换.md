---
title: "类型转换"
publishDate: 2020-11-16 19:26:00 +0800
date: 2020-11-16 19:14:08 +0800
categories: dotnet csharp
position: problem
---

部分类型没有不能进行隐式类型转换，在反射通过属性的SetValue方法赋值时就会报错，比如int32和float?，把int32的值赋值给float?属性就会报错。这里进行一次类型转换，这样就可以了。

---

<div id="toc"></div>

## 代码

```c#
/// <summary>
/// 泛型类型转换
/// </summary>
/// <typeparam name="type">要转换的基础类型</typeparam>
/// <param name="val">要转换的值</param>
/// <returns></returns>
public static object ConvertType(Type type, object val)
{
    //泛型Nullable判断，取其中的类型
    if (type.IsGenericType)
    {
        type = type.GetGenericArguments()[0];
    }
    //string直接返回转换
    if (type.Name.ToLower() == "string")
    {
        return val+"";
    }
    //反射获取TryParse方法
    var tryParse = type.GetMethod("TryParse", BindingFlags.Public | BindingFlags.Static, Type.DefaultBinder,
        new Type[] { typeof(string), type.MakeByRefType() },
        new ParameterModifier[] { new ParameterModifier(2) });
    var parameters = new object[] { val + "", Activator.CreateInstance(type) };
    var success = (bool?)tryParse?.Invoke(null, parameters);
    //成功返回转换后的值，否则返回原值
    return success == true ? parameters[1] : val;
}
```

---
